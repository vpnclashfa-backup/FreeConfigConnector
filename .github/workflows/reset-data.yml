name: Reset Collection Data # نام این Workflow در GitHub UI

on:
  workflow_dispatch: # رویداد: اجازه اجرای دستی از رابط کاربری GitHub را می‌دهد
    inputs:
      confirm_reset:
        description: 'آیا از ریست کردن کامل تمام داده‌های جمع‌آوری شده (شامل حذف پوشه output) مطمئن هستید؟ برای تایید "بله" را تایپ کنید.'
        required: true
        type: string
        default: 'خیر' # 'no' in Farsi

jobs:
  reset-all-data: # نام Job تغییر کرد تا بهتر هدفش رو نشون بده (ریست کامل)
    runs-on: ubuntu-latest
    permissions:
      contents: write # برای Push کردن تغییرات لازم است

    steps:
      - name: Checkout repository # دریافت کد شما از مخزن GitHub
        uses: actions/checkout@v4

      - name: Check Confirmation # بررسی تایید کاربر قبل از ریست
        run: |
          if [ "${{ github.event.inputs.confirm_reset }}" != "بله" ]; then
            echo "Reset confirmed: '${{ github.event.inputs.confirm_reset }}'"
            echo "ریست تایید نشد. بدون تغییرات خارج می‌شود."
            exit 1
          fi
          echo "ریست کامل تایید شد. ادامه عملیات."

      - name: Remove Output Folder and Reset Sources # حذف پوشه output و بازنشانی فایل‌های منبع
        run: |
          echo "حذف کامل پوشه 'output/'..."
          # از 'git rm -rf' برای حذف کامل پوشه output استفاده می‌کنیم.
          # '|| true' اضافه شده تا اگر پوشه وجود نداشت، دستور با خطا مواجه نشود و ادامه یابد.
          git rm -rf output/ || true
          
          echo "بازنشانی فایل‌های منبع (کانال‌ها و وب‌سایت‌ها)..."
          # این کار باعث می‌شود برنامه از یک لیست خالی/پیش‌فرض شروع به کشف منابع کند.
          echo "" > sources/channels.txt # فایل کانال‌ها را خالی می‌کند
          echo "" > sources/websites.txt # فایل وب‌سایت‌ها را خالی می‌کند
          git add sources/channels.txt sources/websites.txt # اضافه کردن تغییرات بازنشانی به Git
          
          # حذف فایل‌های کشف شده (discovered sources)
          git rm -f sources/discovered_telegram_channels.txt || true
          git rm -f sources/discovered_websites.txt || true

          echo "عملیات حذف و بازنشانی به پایان رسید."

      - name: Configure Git # پیکربندی Git برای Commit و Push
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
      - name: Commit and Push Reset # کامیت و Push کردن تغییرات ریست
        run: |
          # 'git add -u .' همه فایل‌های ردیابی شده که حذف یا تغییر کرده‌اند را به مرحله آماده‌سازی اضافه می‌کند.
          git add -u . 

          git commit -m "Auto: Full reset - removed output folder and reset sources" || echo "No changes to commit (files might not have existed or were already removed)"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}